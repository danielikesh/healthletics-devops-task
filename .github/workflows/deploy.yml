name: CI-CD-Healthletics

on:
  push:
    branches: ["main"]

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------
      # Generate version number
      # --------------------------
      - name: Set Version
        id: version
        run: |
          VERSION="1.0.${GITHUB_RUN_NUMBER}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Show version
        run: echo "Building version $VERSION"

      # --------------------------
      # Docker login
      # --------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --------------------------
      # Build Docker image
      # --------------------------
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.IMAGE_REPO }}:${VERSION} .
          docker tag ${{ secrets.IMAGE_REPO }}:${VERSION} ${{ secrets.IMAGE_REPO }}:latest

      # --------------------------
      # Push Docker image
      # --------------------------
      - name: Push Docker image
        run: |
          docker push ${{ secrets.IMAGE_REPO }}:${VERSION}
          docker push ${{ secrets.IMAGE_REPO }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from previous job
        run: echo "VERSION=1.0.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      # --------------------------
      # Setup kubectl + helm
      # --------------------------
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup helm
        uses: azure/setup-helm@v4

      # --------------------------
      # Configure kubeconfig
      # --------------------------
      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      # --------------------------
      # Helm Lint
      # --------------------------
      - name: Helm lint
        run: helm lint helm/myapp

      # --------------------------
      # Helm deploy
      # --------------------------
      - name: Helm upgrade/install
        run: |
          helm upgrade --install healthletic-app helm/myapp \
            --namespace ${{ secrets.K8S_NAMESPACE }} \
            --create-namespace \
            --set image.repository=${{ secrets.IMAGE_REPO }} \
            --set image.tag=${VERSION} \
            --wait --timeout 300s

      - name: Show Pods
        run: kubectl get pods -n ${{ secrets.K8S_NAMESPACE }}

      # --------------------------
      # Smoke Test
      # --------------------------
      - name: Run smoke test
        run: |
          HTTP_CODE=$(kubectl run curl-test --rm -i --tty \
            --image=curlimages/curl \
            -n ${{ secrets.K8S_NAMESPACE }} -- \
            curl -s -o /dev/null -w "%{http_code}" http://healthletic-app:8080/health | tr -dc '0-9')

          echo "HTTP CODE = $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Smoke test failed."
            exit 1
          fi