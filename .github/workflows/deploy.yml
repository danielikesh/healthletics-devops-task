name: CI-CD-Healthletics

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.set_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Set VERSION = 1.0.<run_number>
      - name: Set version
        id: set_version
        run: |
          VERSION="1.0.${GITHUB_RUN_NUMBER}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build + push using official Docker action (avoids buildx CLI issues)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.IMAGE_REPO }}:${{ env.VERSION }}
            ${{ secrets.IMAGE_REPO }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    env:
      IMAGE_REPO: ${{ secrets.IMAGE_REPO }}
      K8S_NAMESPACE: ${{ secrets.K8S_NAMESPACE }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use version from build job
        run: echo "VERSION=${{ needs.build_and_push.outputs.version }}" >> $GITHUB_ENV

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup helm
        uses: azure/setup-helm@v4

      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Helm lint
        run: helm lint helm/myapp

      - name: Helm upgrade/install
        id: helm_deploy
        run: |
          helm upgrade --install healthletic-app helm/myapp \
            --namespace ${K8S_NAMESPACE} \
            --create-namespace \
            --set image.repository=${IMAGE_REPO} \
            --set image.tag=${VERSION} \
            --wait --timeout 300s

      - name: Show pods
        run: kubectl get pods -n ${K8S_NAMESPACE}

      - name: Smoke test /health
        run: |
          HTTP_CODE=$(kubectl run curl-test --rm -i --tty \
            --image=curlimages/curl \
            --restart=Never \
            -n ${K8S_NAMESPACE} -- \
            curl -s -o /dev/null -w "%{http_code}" "http://healthletic-app:8080/health" \
            | tr -dc '0-9')
          echo "HTTP_CODE=${HTTP_CODE}"
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Smoke test failed"
            exit 1
          fi

      - name: Rollback on failure
        if: failure() && steps.helm_deploy.outcome == 'success'
        run: |
          echo "Rolling back previous release..."
          helm rollback healthletic-app 1 -n ${K8S_NAMESPACE} || echo "Rollback failed or no previous revision."
